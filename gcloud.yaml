# ============================================
# AOSP Full Source Build Configuration
# Google Cloud Build
# ============================================

# Define build steps - each step runs in sequence
steps:

  # ========== STEP 1: Install Dependencies ==========
  - name: 'ubuntu:22.04'
    id: 'install-dependencies'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "STEP 1: Installing Dependencies..."
        echo "=========================================="
        
        apt-get update
        
        apt-get install -y \
          git \
          repo \
          python3 \
          ccache \
          openjdk-11-jdk-headless \
          flex \
          bison \
          build-essential \
          zip \
          unzip \
          libssl-dev \
          curl \
          wget \
          imagemagick \
          git-core \
          gnupg \
          liblz4-tool \
          libncurses5-dev \
          libsdl1.2-dev \
          libwxgtk3.0-gtk3-dev \
          lzop \
          pngcrush \
          rsync \
          schedtool \
          squashfs-tools \
          xsltproc \
          yasm \
          zipalign \
          zlib1g-dev \
          dosfstools \
          e2fsprogs \
          fdisk \
          kpartx \
          mtools \
        
        git config --global user.email "aswin14887@gmail.com"
        git config --global user.name "Aswin Vodapally"
        
        echo "✓ Dependencies installed successfully"

  # ========== STEP 2: Install repo Tool ==========
  - name: 'ubuntu:22.04'
    id: 'install-repo'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "STEP 2: Installing repo Tool..."
        echo "=========================================="
        
        apt-get update && apt-get install -y curl ca-certificates

        mkdir -p /usr/local/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > /usr/local/bin/repo
        chmod a+x /usr/local/bin/repo
        repo --version
        
        echo "✓ repo tool installed successfully"
    
    waitFor: ['install-dependencies']

  # ========== STEP 3: Initialize AOSP Repository ==========
  - name: 'ubuntu:22.04'
    id: 'init-repo'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "STEP 3: Initializing AOSP Repository..."
        echo "=========================================="
        
        mkdir -p /workspace/aosp
        cd /workspace/aosp
        
        repo init \
          -u https://android.googlesource.com/platform/manifest \
          -b android-15.0.0_r32 \
          --depth=1 \
          --no-clone-bundle

        apt-get update && apt-get install -y curl ca-certificates

        curl -o .repo/local_manifests/manifest_brcm_rpi.xml \
          -L https://raw.githubusercontent.com/raspberry-vanilla/android_local_manifest/android-15.0/manifest_brcm_rpi.xml --create-dirs

        curl -o .repo/local_manifests/remove_projects.xml \
          -L https://raw.githubusercontent.com/raspberry-vanilla/android_local_manifest/android-15.0/remove_projects.xml
        
        echo "✓ Repository initialized successfully"
    
    waitFor: ['install-repo']

  # ========== STEP 4: Sync AOSP Source Code ==========
  - name: 'ubuntu:22.04'
    id: 'sync-source'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "STEP 4: Syncing AOSP Source Code..."
        echo "This may take 30-60 minutes..."
        echo "=========================================="
        
        cd /workspace/aosp
        
        export USE_CCACHE=1
        export CCACHE_DIR=/workspace/ccache
        mkdir -p $$CCACHE_DIR
        
        repo sync \
          -j8 \
          --no-clone-bundle \
          --no-tags \
          --force-sync
        
        echo "✓ Source code synced successfully"
    
    waitFor: ['init-repo']
    timeout: '7200s'

  # ========== STEP 5: Setup Build Environment ==========
  - name: 'ubuntu:22.04'
    id: 'setup-build-env'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "STEP 5: Setting up Build Environment..."
        echo "=========================================="
        
        cd /workspace/aosp
        
        source build/envsetup.sh
        lunch aosp_rpi5_car-bp1a-userdebug
        
        echo ""
        echo "=========================================="
        echo "Build Configuration:"
        echo "=========================================="
        echo "Platform Version: $$PLATFORM_VERSION"
        echo "Target Product: $$TARGET_PRODUCT"
        echo "Build Variant: $$TARGET_BUILD_VARIANT"
        echo "=========================================="
        
        echo "✓ Build environment configured successfully"
    
    waitFor: ['sync-source']

  # ========== STEP 6: Build AOSP ==========
  - name: 'ubuntu:22.04'
    id: 'build-aosp'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "STEP 6: Building AOSP..."
        echo "This will take 2-6 hours..."
        echo "=========================================="
        
        cd /workspace/aosp
        
        source build/envsetup.sh
        lunch aosp_rpi5_car-bp1a-userdebug
        
        export USE_CCACHE=1
        export CCACHE_DIR=/workspace/ccache
        
        make bootimage systemimage vendorimage -j4 2>&1 | tee /workspace/build.log
        
        echo ""
        echo "=========================================="
        echo "✓ Build completed successfully!"
        echo "=========================================="
    
    waitFor: ['setup-build-env']
    timeout: '14400s'

  # ========== STEP 7: Upload Build Artifacts ==========
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-artifacts'
    args:
      - '-m'
      - 'cp'
      - '-r'
      - '/workspace/aosp/out/target/product/'
      - 'gs://dulcet-analyst-484512-n8/build-${BUILD_ID}/'
    
    waitFor: ['build-aosp']

  # ========== STEP 8: Upload Build Log ==========
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-log'
    args:
      - 'cp'
      - '/workspace/build.log'
      - 'gs://dulcet-analyst-484512-n8/build-${BUILD_ID}/build.log'
    
    waitFor: ['build-aosp']

# ============================================
# Build Options & Configuration
# ============================================

options:
  machineType: 'N1_HIGHCPU_8'
  logging: CLOUD_LOGGING_ONLY

timeout: '21600s'
