# ============================================
# AOSP Full Source Build Configuration
# Google Cloud Build
# ============================================

# Define build steps - each step runs in sequence
steps:

  # ========== STEP 1: Install Dependencies ==========
  - name: 'ubuntu:22.04'
    id: 'install-dependencies'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "STEP 1: Installing Dependencies..."
        echo "=========================================="
        
        apt-get update
        
        apt-get install -y \
          git \
          repo \
          python3 \
          ccache \
          openjdk-11-jdk-headless \
          flex \
          bison \
          build-essential \
          zip \
          unzip \
          libssl-dev \
          curl \
          wget \
          imagemagick \
          git-core \
          gnupg \
          liblz4-tool \
          libncurses5-dev \
          libsdl1.2-dev \
          libwxgtk3.0-gtk3-dev \
          lzop \
          pngcrush \
          rsync \
          schedtool \
          squashfs-tools \
          xsltproc \
          yasm \
          zipalign \
          zlib1g-dev \
          dosfstools \
          e2fsprogs \
          fdisk \
          kpartx \
          mtools
        
        git config --global user.email "aswin14887@gmail.com"
        git config --global user.name "Aswin Vodapally"
        
        echo "✓ Dependencies installed successfully"

  # ========== STEP 2: Initialize AOSP Repository ==========
  - name: 'ubuntu:22.04'
    id: 'repo-init'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "STEP 2: Initializing AOSP Repository..."
        echo "=========================================="
        
        apt-get update && apt-get install -y git repo python3 curl
        
        mkdir -p /workspace/aosp
        cd /workspace/aosp
        
        repo init \
          -u https://android.googlesource.com/platform/manifest \
          -b android-15.0.0_r32 \
          --depth=1 \
          --no-clone-bundle

        curl -o .repo/local_manifests/manifest_brcm_rpi.xml \
          -L https://raw.githubusercontent.com/raspberry-vanilla/android_local_manifest/android-15.0/manifest_brcm_rpi.xml --create-dirs

        curl -o .repo/local_manifests/remove_projects.xml \
          -L https://raw.githubusercontent.com/raspberry-vanilla/android_local_manifest/android-15.0/remove_projects.xml
        
        echo "✓ Repository initialized successfully"
    
    waitFor: ['install-dependencies']

  # ========== STEP 3: Sync AOSP Source Code ==========
  - name: 'ubuntu:22.04'
    id: 'sync-source'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "STEP 3: Syncing AOSP Source Code..."
        echo "This may take 30-60 minutes..."
        echo "=========================================="
        
        apt-get update && apt-get install -y git repo python3 curl
        
        cd /workspace/aosp
        
        export USE_CCACHE=1
        export CCACHE_DIR=/workspace/ccache
        mkdir -p $$CCACHE_DIR
        
        repo sync \
          -j8 \
          --no-clone-bundle \
          --no-tags \
          --force-sync
        
        echo "✓ Source code synced successfully"
    
    waitFor: ['repo-init']
    timeout: '7200s'

  # ========== STEP 4: Build AOSP ==========
  - name: 'ubuntu:22.04'
    id: 'build-aosp'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        echo "=========================================="
        echo "STEP 4: Building AOSP..."
        echo "This will take 2-6 hours..."
        echo "=========================================="
        
        apt-get update && apt-get install -y git repo python3 openjdk-11-jdk-headless flex bison build-essential
        
        cd /workspace/aosp
        
        source build/envsetup.sh
        lunch aosp_rpi5_car-bp1a-userdebug
        
        export USE_CCACHE=1
        export CCACHE_DIR=/workspace/ccache
        
        make bootimage systemimage vendorimage -j1 2>&1 | tee /workspace/build.log
        
        echo ""
        echo "=========================================="
        echo "✓ Build completed successfully!"
        echo "=========================================="
    
    waitFor: ['sync-source']
    timeout: '28800s'

  # ========== STEP 5: Upload Build Artifacts ==========
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-artifacts'
    args:
      - '-m'
      - 'cp'
      - '-r'
      - '/workspace/aosp/out/target/product/'
      - 'gs://dulcet-analyst-484512-n8/build-$BUILD_ID/'
    
    waitFor: ['build-aosp']

  # ========== STEP 6: Upload Build Log ==========
  - name: 'gcr.io/cloud-builders/gsutil'
    id: 'upload-log'
    args:
      - 'cp'
      - '/workspace/build.log'
      - 'gs://dulcet-analyst-484512-n8/build-$BUILD_ID/build.log'
    
    waitFor: ['build-aosp']

# ============================================
# Build Options & Configuration
# ============================================

options:
  machineType: 'E2_HIGHCPU_32'
  diskSizeGb: 1000
  logging: CLOUD_LOGGING_ONLY

timeout: '21600s'